{"version":3,"file":"pane.js","names":["UI","authn","$rdf","ns","formPane","icon","icons","iconBase","name","audience","solid","label","subject","n","widgets","formsFor","length","log","debug","render","context","kb","session","store","dom","mention","complain","message","style","pre","createElement","setAttribute","box","appendChild","textContent","complainIfBad","ok","body","me","currentUser","ws","each","ui","renderFormsFor","fetcher","nowOrWhenFetched","uri","forms","i","form","heading","formStore","Util","document","e","editFormButton","anchor","utils","appendForm","docuri","docpart","updater","editable","doc","any","sym","link","docs","docList","statementsMatching","forEach","st","why","undefined","d","push","sort","_followeach","path","oo","res","concat","slice","date","foobarbaz","login","selectWorkspace","activities","space","j","act","subjectDoc2","start","cal","value","end"],"sources":["../../src/form/pane.js"],"sourcesContent":["/*\n **             Pane for running existing forms for any object\n **\n */\n\nimport * as UI from 'solid-ui-jss'\nimport { authn } from 'solid-logic-jss'\nimport * as $rdf from 'rdflib'\nconst ns = UI.ns\n\nexport const formPane = {\n  icon: UI.icons.iconBase + 'noun_122196.svg',\n\n  name: 'form',\n\n  audience: [ns.solid('PowerUser')],\n\n  // Does the subject deserve this pane?\n  label: function (subject) {\n    const n = UI.widgets.formsFor(subject).length\n    UI.log.debug('Form pane: forms for ' + subject + ': ' + n)\n    if (!n) return null\n    return '' + n + ' forms'\n  },\n\n  render: function (subject, context) {\n    const kb = context.session.store\n    const dom = context.dom\n\n    const mention = function complain (message, style) {\n      const pre = dom.createElement('p')\n      pre.setAttribute('style', style || 'color: grey; background-color: white')\n      box.appendChild(pre).textContent = message\n      return pre\n    }\n\n    const complain = function complain (message, style) {\n      mention(message, 'style', style || 'color: grey; background-color: #fdd;')\n    }\n\n    const complainIfBad = function (ok, body) {\n      if (ok) {\n        // setModifiedDate(store, kb, store);\n        // rerender(box);   // Deleted forms at the moment\n      } else complain('Sorry, failed to save your change:\\n' + body)\n    }\n\n    // The question of where to store this data about subject\n    // This in general needs a whole lot more thought\n    // and it connects to the discoverbility through links\n\n    // const t = kb.findTypeURIs(subject)\n\n    const me = authn.currentUser()\n\n    const box = dom.createElement('div')\n    box.setAttribute('class', 'formPane')\n\n    if (!me) {\n      mention(\n        'You are not logged in. If you log in and have ' +\n          'workspaces then you would be able to select workspace in which ' +\n          'to put this new information'\n      )\n    } else {\n      const ws = kb.each(me, ns.ui('workspace'))\n      if (ws.length === 0) {\n        mention(\n          'You don\\'t seem to have any workspaces defined.  ' +\n            'A workspace is a place on the web (http://..) or in ' +\n            'the file system (file:///) to store application data.\\n'\n        )\n      } else {\n        // @@\n      }\n    }\n\n    // Render forms using a given store\n\n    const renderFormsFor = function (store, subject) {\n      kb.fetcher.nowOrWhenFetched(store.uri, subject, function (ok, body) {\n        if (!ok) return complain('Cannot load store ' + store.uri + ': ' + body)\n\n        //              Render the forms\n\n        const forms = UI.widgets.formsFor(subject)\n\n        // complain('Form for editing this form:');\n        for (let i = 0; i < forms.length; i++) {\n          const form = forms[i]\n          const heading = dom.createElement('h4')\n          box.appendChild(heading)\n          if (form.uri) {\n            const formStore = $rdf.Util.uri.document(form.uri)\n            if (formStore.uri !== form.uri) {\n              // The form is a hash-type URI\n              const e = box.appendChild(\n                UI.widgets.editFormButton(\n                  dom,\n                  box,\n                  form,\n                  formStore,\n                  complainIfBad\n                )\n              )\n              e.setAttribute('style', 'float: right;')\n            }\n          }\n          const anchor = dom.createElement('a')\n          anchor.setAttribute('href', form.uri)\n          heading.appendChild(anchor)\n          anchor.textContent = UI.utils.label(form, true)\n\n          /*  Keep tis as a reminder to let a New one have its URI given by user\n          mention(\"Where will this information be stored?\")\n          const ele = dom.createElement('input');\n          box.appendChild(ele);\n          ele.setAttribute('type', 'text');\n          ele.setAttribute('size', '72');\n          ele.setAttribute('maxlength', '1024');\n          ele.setAttribute('style', 'font-size: 80%; color:#222;');\n          ele.value = store.uri\n          */\n\n          UI.widgets.appendForm(\n            dom,\n            box,\n            {},\n            subject,\n            form,\n            store,\n            complainIfBad\n          )\n        }\n      }) // end: when store loded\n    } // renderFormsFor\n\n    // Figure out what store\n\n    // Which places are editable and have stuff about the subject?\n\n    let store = null\n\n    // 1. The document URI of the subject itself\n    const docuri = $rdf.Util.uri.docpart(subject.uri)\n    if (subject.uri !== docuri && kb.updater.editable(docuri, kb)) {\n      store = subject.doc()\n    } // an editable data file with hash\n\n    store = store || kb.any(kb.sym(docuri), ns.link('annotationStore'))\n\n    // 2. where stuff is already stored\n    if (!store) {\n      const docs = {}\n      const docList = []\n      store.statementsMatching(subject).forEach(function (st) {\n        docs[st.why.uri] = 1\n      })\n      store\n        .statementsMatching(undefined, undefined, subject)\n        .forEach(function (st) {\n          docs[st.why.uri] = 2\n        })\n      for (const d in docs) docList.push(docs[d], d)\n      docList.sort()\n      for (let i = 0; i < docList.length; i++) {\n        const uri = docList[i][1]\n        if (uri && store.updater.editable(uri)) {\n          store = store.sym(uri)\n          break\n        }\n      }\n    }\n\n    // 3. In a workspace store\n    // @@ TODO: Can probably remove _followeach (not done this time because the commit is a very safe refactor)\n    const _followeach = function (kb, subject, path) {\n      if (path.length === 0) return [subject]\n      const oo = kb.each(subject, path[0])\n      let res = []\n      for (let i = 0; i < oo.length; i++) {\n        res = res.concat(_followeach(kb, oo[i], path.slice(1)))\n      }\n      return res\n    }\n\n    const date = '2014' // @@@@@@@@@@@@ pass as parameter\n\n    if (store) {\n      // mention(\"@@ Ok, we have a store <\" + store.uri + \">.\");\n      renderFormsFor(store, subject)\n    } else {\n      complain('No suitable store is known, to edit <' + subject.uri + '>.')\n      const foobarbaz = UI.login.selectWorkspace(dom, function (ws) {\n        mention('Workspace selected OK: ' + ws)\n\n        const activities = store.each(undefined, ns.space('workspace'), ws)\n        for (let j = 0; j < activities.length; j++) {\n          const act = activities[j]\n\n          const subjectDoc2 = store.any(ws, ns.space('store'))\n          const start = store.any(ws, ns.cal('dtstart')).value()\n          const end = store.any(ws, ns.cal('dtend')).value()\n          if (subjectDoc2 && start && end && start <= date && end > date) {\n            renderFormsFor(subjectDoc2, subject)\n            break\n          } else {\n            complain('Note no suitable annotation store in activity: ' + act)\n          }\n        }\n      })\n      box.appendChild(foobarbaz)\n    }\n\n    return box\n  }\n}\n"],"mappings":"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","ignoreList":[]}