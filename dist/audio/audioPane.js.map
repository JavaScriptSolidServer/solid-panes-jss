{"version":3,"file":"audioPane.js","names":["UI","$rdf","ns","icon","icons","iconBase","name","label","subject","context","kb","session","store","typeURIs","findTypeURIs","prefix","Util","mediaTypeClass","uri","split","t","startsWith","render","dom","options","autoplay","chain","chainAlbums","loop","removeExtension","str","dot","lastIndexOf","slash","slice","looksRedundant","x","folder","any","undefined","ldp","contents","each","length","thisName","k","otherName","endsWith","guessNames","a","decode","decodeURIComponent","e","artistRow","textContent","albumRow","trackRow","moveOn","current","level","Promise","resolve","dir","fetcher","load","then","_xhr","j","sort","i","folder2","console","log","endedListener","event","sym","target","getAttribute","tryNext","cur","next","controlRow","appendChild","audioControl","removeChild","song","audio","createElement","setAttribute","_fetch","response","blob","myBlob","objectURL","URL","createObjectURL","addEventListener","div","table","labelStyle","style","cssText","holds"],"sources":["../../src/audio/audioPane.js"],"sourcesContent":["/*   Single audio play Pane\n **\n */\nimport * as UI from 'solid-ui-jss'\nimport * as $rdf from 'rdflib'\nconst ns = UI.ns\n\nexport default {\n  icon: UI.icons.iconBase + 'noun_534313.svg',\n\n  name: 'audio',\n\n  // Does the subject deserve an audio play pane?\n  label: function (subject, context) {\n    const kb = context.session.store\n    const typeURIs = kb.findTypeURIs(subject)\n\n    const prefix = $rdf.Util.mediaTypeClass('audio/*').uri.split('*')[0]\n    for (const t in typeURIs) {\n      if (t.startsWith(prefix)) return 'Play audio'\n    }\n    return null\n  },\n\n  render: function (subject, context) {\n    const kb = context.session.store\n    const dom = context.dom\n    const options = {\n      autoplay: false,\n      chain: true,\n      chainAlbums: true,\n      loop: false\n    }\n\n    const removeExtension = function (str) {\n      const dot = str.lastIndexOf('.')\n      if (dot < 0) return str // if any\n      const slash = str.lastIndexOf('/')\n      if (dot < slash) return str\n      return str.slice(0, dot)\n    }\n\n    // True if there is another file like song.mp3 when this is \"song 1.mp3\"\n    // or this is song.m4a\n    //\n    const looksRedundant = function (x) {\n      const folder = kb.any(undefined, ns.ldp('contains'), x)\n      if (!folder) return false\n      const contents = kb.each(folder, ns.ldp('contains'))\n      if (contents.length < 2) return false\n      const thisName = x.uri\n      for (let k = 0; k < contents.length; k++) {\n        const otherName = contents[k].uri\n        if (\n          thisName.length > otherName.length &&\n          thisName.startsWith(removeExtension(otherName))\n        ) {\n          return true\n        }\n        if (\n          thisName.endsWith('.m4a') &&\n          otherName.endsWith('.mp3') &&\n          removeExtension(thisName) === removeExtension(otherName)\n        ) {\n          return true\n        }\n      }\n      return false\n    }\n\n    // Alternative methods could include:\n    // Accesing metadata in the audio contol, or paring the audio file\n    const guessNames = function (x) {\n      const a = x.uri.split('/').slice(-3) // Hope artist, album, track\n      const decode = function (str) {\n        try {\n          return decodeURIComponent(str)\n        } catch (e) {\n          return str\n        }\n      }\n      artistRow.textContent = decode(a[0])\n      albumRow.textContent = decode(a[1])\n      trackRow.textContent = decode(removeExtension(a[2]))\n    }\n\n    const moveOn = function (current, level) {\n      return new Promise(function (resolve) {\n        level = level || 0\n        if (!options.chain) return resolve(null)\n        // Ideally navigate graph else cheat with URI munging:\n        const folder =\n          kb.any(undefined, ns.ldp('contains'), current) || current.dir()\n        if (!folder) return resolve(null)\n        kb.fetcher.load(folder).then(function (_xhr) {\n          const contents = kb.each(folder, ns.ldp('contains')) // @@ load if not loaded\n          // if (contents.length < 2) return resolve(null)   NO might move on from 1-track album\n          let j\n          contents.sort() // sort by URI which hopefully will get tracks in order\n          for (let i = 0; i < contents.length; i++) {\n            if (current.uri === contents[i].uri) {\n              j = (i + 1) % contents.length\n              if (j === 0) {\n                if (!options.chainAlbums) {\n                  if (options.loop) {\n                    return resolve(contents[j])\n                  }\n                  return resolve(null) // No more music needed\n                } else {\n                  // chain albums\n                  if (level === 1 || !options.chainAlbums) return resolve(null) // limit of navigating treee\n                  moveOn(folder, level + 1).then(function (folder2) {\n                    if (folder2) {\n                      kb.fetcher.load(folder2).then(function (_xhr) {\n                        const contents = kb.each(folder2, ns.ldp('contains'))\n                        if (contents.length === 0) return resolve(null)\n                        contents.sort()\n                        console.log('New Album: ' + folder2)\n                        return resolve(contents[0]) // Start off new album\n                      })\n                    }\n                  })\n                }\n              } else {\n                return resolve(contents[j])\n              }\n            }\n          } // for\n        })\n      })\n    }\n    const endedListener = function (event) {\n      const current = kb.sym(event.target.getAttribute('src'))\n      if (!options.chain) return\n      const tryNext = function (cur) {\n        const current = cur\n        moveOn(current).then(function (next) {\n          if (!next) {\n            console.log('No successor to ' + current)\n            return\n          }\n          if (!looksRedundant(next)) {\n            console.log('Moving on to ' + next)\n            guessNames(next)\n            controlRow.appendChild(audioControl(next, true)) // Force autoplay\n            controlRow.removeChild(event.target)\n          } else {\n            console.log('Ignoring redundant ' + next)\n            tryNext(next)\n          }\n        })\n      }\n      tryNext(current)\n    }\n\n    const audioControl = function (song, autoplay) {\n      const audio = dom.createElement('audio')\n      audio.setAttribute('controls', 'yes')\n      // get audio with authenticated fetch\n      kb.fetcher._fetch(song.uri)\n        .then(function (response) {\n          return response.blob()\n        })\n        .then(function (myBlob) {\n          const objectURL = URL.createObjectURL(myBlob)\n          audio.setAttribute('src', objectURL) // w640 h480 //\n        })\n\n      if (autoplay) {\n        audio.setAttribute('autoplay', 'autoplay') // Make this a personal preference\n      }\n      audio.addEventListener('ended', endedListener, false)\n      return audio\n    }\n\n    const div = dom.createElement('div')\n    const table = div.appendChild(dom.createElement('table'))\n    const labelStyle = 'padding: 0.3em; color:white; background-color: black;'\n    const artistRow = table.appendChild(dom.createElement('tr'))\n    artistRow.style.cssText = labelStyle\n    const albumRow = table.appendChild(dom.createElement('tr'))\n    albumRow.style.cssText = labelStyle\n    const trackRow = table.appendChild(dom.createElement('tr'))\n    trackRow.style.cssText = labelStyle\n    const controlRow = table.appendChild(dom.createElement('tr'))\n    guessNames(subject)\n    controlRow.appendChild(audioControl(subject, options.autoplay))\n\n    if (!kb.holds(undefined, ns.ldp('contains'), subject) && subject.dir()) {\n      kb.fetcher.load(subject.dir()) // Prefetch enclosing @@ or playlist\n    }\n\n    return div\n  }\n}\n\n// ends\n"],"mappings":"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","ignoreList":[]}