{"version":3,"file":"trustedApplications.dom.js","names":["sym","ns","store","generateRandomString","getStatementsToAdd","getStatementsToDelete","createApplicationTable","subject","applicationsTable","createElement","class","header","createContainer","createText","appendChild","each","acl","undefined","flatMap","app","map","origin","appModes","sort","a","b","value","forEach","createApplicationEntry","updateTable","parentElement","replaceChild","trustedApplicationState","formElements","modes","placeholder","element","submit","addOrEditApplication","createModesInput","style","click","removeApplication","event","preventDefault","err","alert","filter","checkbox","checked","deletions","additions","updater","Error","update","handleUpdateResponse","uri","success","errorBody","elementName","attributes","eventListeners","onCreated","document","Object","keys","attName","setAttribute","eventName","addEventListener","children","child","textContent","mode","isChecked","some","appMode","type","push"],"sources":["../../src/trustedApplications/trustedApplications.dom.ts"],"sourcesContent":["import { NamedNode, Statement, sym } from 'rdflib'\nimport { ns } from 'solid-ui-jss'\nimport { store } from 'solid-logic-jss'\nimport { generateRandomString, getStatementsToAdd, getStatementsToDelete } from './trustedApplications.utils'\n\ninterface FormElements {\n  modes: HTMLInputElement[]\n  // This appears to be used to store either a node from the store,\n  // or a reference to the input (checkbox) element for a particular mode.\n  // These typings were created post-hoc, so I'm not sure if that was intentional.\n  // Thus, this union type should be considered as descriptive rather than prescriptive.\n  origin: undefined | NamedNode | HTMLInputElement\n}\n\nexport function createApplicationTable (subject: NamedNode) {\n  const applicationsTable = createElement('table', {\n    class: 'results'\n  })\n\n  // creating headers\n  const header = createContainer('tr', [\n    createText('th', 'Application URL'),\n    createText('th', 'Access modes'),\n    createText('th', 'Actions')\n  ])\n  applicationsTable.appendChild(header);\n\n  // creating rows\n  (store.each(subject, ns.acl('trustedApp'), undefined, undefined) as unknown as Statement[])\n    .flatMap(app => store\n      .each(app as any, ns.acl('origin'), undefined, undefined)\n      .map(origin => ({\n        appModes: store.each(app as any, ns.acl('mode'), undefined, undefined) as NamedNode[],\n        origin: origin as NamedNode\n      })))\n    .sort((a: any, b: any) => (a.origin.value < b.origin.value ? -1 : 1))\n    .forEach(\n      ({ appModes, origin }: { appModes: NamedNode[]; origin: NamedNode }) =>\n        applicationsTable.appendChild(\n          createApplicationEntry(subject, origin, appModes, updateTable)\n        )\n    )\n\n  // adding a row for new applications\n  applicationsTable.appendChild(\n    createApplicationEntry(subject, null, [ns.acl('Read')], updateTable)\n  )\n\n  return applicationsTable\n\n  function updateTable () {\n    applicationsTable.parentElement!.replaceChild(\n      createApplicationTable(subject),\n      applicationsTable\n    )\n  }\n}\n\nfunction createApplicationEntry (\n  subject: NamedNode,\n  origin: NamedNode | null,\n  appModes: NamedNode[],\n  updateTable: () => void\n): HTMLTableRowElement {\n  const trustedApplicationState = {\n    origin,\n    appModes,\n    formElements: {\n      modes: [],\n      origin: undefined\n    } as FormElements\n  }\n  return createContainer('tr', [\n    createContainer('td', [\n      createContainer(\n        'form',\n        [\n          createElement(\n            'input',\n            {\n              class: 'textinput',\n              placeholder: 'Write new URL here',\n              value: origin ? origin.value : ''\n            },\n            {},\n            element => {\n              trustedApplicationState.formElements.origin = element\n            }\n          )\n        ],\n        {},\n        {\n          submit: addOrEditApplication\n        }\n      )\n    ]),\n    createContainer('td', [\n      createContainer(\n        'form',\n        createModesInput(trustedApplicationState),\n        {},\n        {\n          submit: addOrEditApplication\n        }\n      )\n    ]),\n    createContainer('td', [\n      createContainer(\n        'form',\n        origin\n          ? [\n              createText('button', 'Update', {\n                class: 'controlButton',\n                style: 'background: LightGreen;'\n              }),\n              createText(\n                'button',\n                'Delete',\n                {\n                  class: 'controlButton',\n                  style: 'background: LightCoral;'\n                },\n                {\n                  click: removeApplication\n                }\n              )\n            ]\n          : [\n              createText('button', 'Add', {\n                class: 'controlButton',\n                style: 'background: LightGreen;'\n              })\n            ],\n        {},\n        {\n          submit: addOrEditApplication\n        }\n      )\n    ])\n  ])\n\n  function addOrEditApplication (event: Event) {\n    event.preventDefault()\n    let origin\n    try {\n      origin = sym(trustedApplicationState.formElements.origin!.value)\n    } catch (err) {\n      return alert('Please provide an application URL you want to trust')\n    }\n\n    const modes = trustedApplicationState.formElements.modes\n      .filter(checkbox => checkbox.checked)\n      .map(checkbox => checkbox.value)\n\n    const deletions = getStatementsToDelete(\n      trustedApplicationState.origin || origin,\n      subject,\n      store,\n      ns\n    )\n    const additions = getStatementsToAdd(\n      origin,\n      generateRandomString(),\n      modes,\n      subject,\n      ns\n    )\n    if (!store.updater) {\n      throw new Error('Store has no updater')\n    }\n    store.updater.update(deletions, additions, handleUpdateResponse)\n  }\n\n  function removeApplication (event: Event) {\n    event.preventDefault()\n    let origin\n    try {\n      origin = sym(trustedApplicationState.formElements.origin!.value)\n    } catch (err) {\n      return alert(\n        'Please provide an application URL you want to remove trust from'\n      )\n    }\n\n    const deletions = getStatementsToDelete(origin, subject, store, ns)\n    if (!store.updater) {\n      throw new Error('Store has no updater')\n    }\n    store.updater.update(deletions, [], handleUpdateResponse)\n  }\n\n  function handleUpdateResponse (uri: any, success: boolean, errorBody: any) {\n    if (success) {\n      return updateTable()\n    }\n    // console.error(uri, errorBody)\n  }\n}\n\nfunction createElement<K extends keyof globalThis.HTMLElementTagNameMap> (\n  elementName: K,\n  attributes: { [name: string]: string } = {},\n  eventListeners: { [eventName: string]: globalThis.EventListener } = {},\n\n  onCreated: null | ((createdElement: globalThis.HTMLElementTagNameMap[K]) => void) = null\n) {\n  const element = document.createElement(elementName)\n  if (onCreated) {\n    onCreated(element)\n  }\n  Object.keys(attributes).forEach(attName => {\n    element.setAttribute(attName, attributes[attName])\n  })\n  Object.keys(eventListeners).forEach(eventName => {\n    element.addEventListener(eventName, eventListeners[eventName])\n  })\n  return element\n}\n\nexport function createContainer<K extends keyof globalThis.HTMLElementTagNameMap> (\n  elementName: K,\n  children: HTMLElement[],\n  attributes = {},\n  eventListeners = {},\n  onCreated = null\n) {\n  const element = createElement(\n    elementName,\n    attributes,\n    eventListeners,\n    onCreated\n  )\n  children.forEach(child => element.appendChild(child))\n  return element\n}\n\nexport function createText<K extends keyof globalThis.HTMLElementTagNameMap> (\n  elementName: K,\n  textContent: string | null,\n  attributes = {},\n  eventListeners = {},\n  onCreated = null\n) {\n  const element = createElement(\n    elementName,\n    attributes,\n    eventListeners,\n    onCreated\n  )\n  element.textContent = textContent\n  return element\n}\n\nfunction createModesInput ({ appModes, formElements }: {\n  appModes: NamedNode[]\n  formElements: FormElements\n}) {\n  return ['Read', 'Write', 'Append', 'Control'].map(mode => {\n    const isChecked = appModes.some(\n      appMode => appMode.value === ns.acl(mode).value\n    )\n    return createContainer('label', [\n      createElement(\n        'input',\n        {\n          type: 'checkbox',\n          ...(isChecked ? { checked: '' } : {}),\n          value: ns.acl(mode).uri\n        },\n        {},\n        element => formElements.modes.push(element)\n      ),\n      createText('span', mode)\n    ])\n  })\n}\n"],"mappings":"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","ignoreList":[]}