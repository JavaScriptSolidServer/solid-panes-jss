{"version":3,"file":"humanReadablePane.js","names":["icons","ns","Util","marked","DOMPurify","humanReadablePane","icon","originalIconBase","name","label","subject","context","kb","session","store","allowed","hasContentTypeIn","x","displayables","cts","fetcher","getHeader","j","length","k","indexOf","hasContentTypeIn2","t","findTypeURIs","mediaTypeClass","uri","link","render","myDocument","dom","div","createElement","doc","ct","split","trim","console","log","setAttribute","element","frame","setIframeAttributes","blob","lines","URL","createObjectURL","type","markdownHtml","webOperation","then","response","markdownText","responseText","Math","min","res","parse","clean","sanitize","innerHTML","catch","error","_fetch","blobTextPromise","startsWith","text","Promise","resolve","blobText","newLines","includes","err","tr","appendChild"],"sources":["../src/humanReadablePane.js"],"sourcesContent":["/*   Human-readable Pane\n **\n **  This outline pane contains the document contents for an HTML document\n **  This is for peeking at a page, because the user might not want to leave the data browser.\n */\nimport { icons, ns } from 'solid-ui-jss'\nimport { Util } from 'rdflib'\nimport { marked } from 'marked'\nimport DOMPurify from 'dompurify'\n\nconst humanReadablePane = {\n  icon: icons.originalIconBase + 'tango/22-text-x-generic.png',\n\n  name: 'humanReadable',\n\n  label: function (subject, context) {\n    const kb = context.session.store\n\n    //   See also the source pane, which has lower precedence.\n\n    const allowed = [\n      'text/plain',\n      'text/html',\n      'text/markdown',\n      'application/xhtml+xml',\n      'image/png',\n      'image/jpeg',\n      'application/pdf',\n      'video/mp4'\n    ]\n\n    const hasContentTypeIn = function (kb, x, displayables) {\n      const cts = kb.fetcher.getHeader(x, 'content-type')\n      if (cts) {\n        for (let j = 0; j < cts.length; j++) {\n          for (let k = 0; k < displayables.length; k++) {\n            if (cts[j].indexOf(displayables[k]) >= 0) {\n              return true\n            }\n          }\n        }\n      }\n      return false\n    }\n\n    // This data could come from a fetch OR from ldp container\n    const hasContentTypeIn2 = function (kb, x, displayables) {\n      const t = kb.findTypeURIs(x)\n      for (let k = 0; k < displayables.length; k++) {\n        if (Util.mediaTypeClass(displayables[k]).uri in t) {\n          return true\n        }\n      }\n      return false\n    }\n\n    if (!subject.uri) return null // no bnodes\n\n    const t = kb.findTypeURIs(subject)\n    if (t[ns.link('WebPage').uri]) return 'view'\n\n    if (\n      hasContentTypeIn(kb, subject, allowed) ||\n      hasContentTypeIn2(kb, subject, allowed)\n    ) {\n      return 'View'\n    }\n\n    return null\n  },\n\n  render: function (subject, context) {\n    const myDocument = context.dom\n    const div = myDocument.createElement('div')\n    const kb = context.session.store\n\n    const cts = kb.fetcher.getHeader(subject.doc(), 'content-type')\n    const ct = cts ? cts[0].split(';', 1)[0].trim() : null // remove content-type parameters\n    if (ct) {\n      // console.log('humanReadablePane: c-t:' + ct)\n    } else {\n      console.log('humanReadablePane: unknown content-type?')\n    }\n\n    //  @@ When we can, use CSP to turn off scripts within the iframe\n    div.setAttribute('class', 'docView')\n    const element = ct === 'text/markdown' ? 'DIV' : 'IFRAME'\n    const frame = myDocument.createElement(element)\n\n    const setIframeAttributes = (frame, blob, lines) => {\n      frame.setAttribute('src', URL.createObjectURL(blob))\n      frame.setAttribute('type', blob.type)\n      frame.setAttribute('class', 'doc')\n      frame.setAttribute('style', `border: 1px solid; padding: 1em; height: ${lines}em; width: 800px; resize: both; overflow: auto;`)\n\n      // Apply sandbox attribute only for HTML files\n      // @@ Note below - if we set ANY sandbox, then Chrome and Safari won't display it if it is PDF.\n      // https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe\n      // You can't have any sandbox and allow plugins.\n      // We could sandbox only HTML files I suppose.\n      if (blob.type === 'text/html' || blob.type === 'application/xhtml+xml') {\n        frame.setAttribute('sandbox', 'allow-scripts allow-same-origin')\n      }\n    }\n\n    // render markdown to html\n    const markdownHtml = function () {\n      kb.fetcher.webOperation('GET', subject.uri).then(response => {\n        const markdownText = response.responseText\n        const lines = Math.min(30, markdownText.split(/\\n/).length + 5)\n        const res = marked.parse(markdownText)\n        const clean = DOMPurify.sanitize(res)\n        frame.innerHTML = clean\n        frame.setAttribute('class', 'doc')\n        frame.setAttribute('style', `border: 1px solid; padding: 1em; height: ${lines}em; width: 800px; resize: both; overflow: auto;`)\n      }).catch(error => {\n        console.error('Error fetching markdown content:', error)\n        frame.innerHTML = '<p>Error loading content</p>'\n      })\n    }\n\n    if (ct === 'text/markdown') {\n      markdownHtml()\n    } else {\n    // Fetch and process the blob\n      kb.fetcher._fetch(subject.uri)\n        .then(response => response.blob())\n        .then(blob => {\n          const blobTextPromise = blob.type.startsWith('text') ? blob.text() : Promise.resolve('')\n          return blobTextPromise.then(blobText => ({ blob, blobText }))\n        })\n        .then(({ blob, blobText }) => {\n          const newLines = blobText.includes('<script src=\"https://dokie.li/scripts/dokieli.js\">') ? -10 : 5\n          const lines = Math.min(30, blobText.split(/\\n/).length + newLines)\n          setIframeAttributes(frame, blob, lines)\n        })\n        .catch(err => {\n          console.log('Error fetching or processing blob:', err)\n        })\n    }\n\n    const tr = myDocument.createElement('TR')\n    tr.appendChild(frame)\n    div.appendChild(tr)\n    return div\n  }\n}\n\nexport default humanReadablePane\n// ends\n"],"mappings":"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","ignoreList":[]}