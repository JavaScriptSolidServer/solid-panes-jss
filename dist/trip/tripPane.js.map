{"version":3,"file":"tripPane.js","names":["UI","_interopRequireWildcard","require","$rdf","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","ns","_default","exports","icon","icons","iconBase","name","audience","solid","label","subject","context","kb","session","store","findTypeURIs","qu","findSuperClassesNT","render","myDocument","dom","CAL","Namespace","TRIP","div","createElement","setAttribute","innerHTML","complain","message","style","undefined","pre","appendChild","createTextNode","renderTrip","thisDiv","query","Query","utils","vars","v","forEach","x","push","variable","pat","add","transaction","opt","formula","rdf","type","optional","date","rdfs","comment","in_USD","calculations","total","trans","each","ty","the","uri","tyuri","lit","any","parseFloat","value","str","types","grandTotal","sym","length","tableDiv","table","onDone","ts","triples","index","trip","transactions","usd","toNT","list","h1","t1","fromNT","sort","j","t2"],"sources":["../../src/trip/tripPane.js"],"sourcesContent":["/*   Trip Pane\n **\n ** This pane deals with trips themselves and also\n ** will look at transactions organized by trip.\n **\n **  This outline pane allows a user to interact with a transaction\n **  downloaded from a bank statement, annotting it with classes and comments,\n **  trips, etc\n */\n\nimport * as UI from 'solid-ui-jss'\nimport * as $rdf from 'rdflib'\nconst ns = UI.ns\n\nexport default {\n  icon: UI.icons.iconBase + 'noun_62007.svg',\n\n  name: 'travel expenses',\n\n  audience: [ns.solid('PowerUser')],\n\n  // Does the subject deserve this pane?\n  label: function (subject, context) {\n    const kb = context.session.store\n    const t = kb.findTypeURIs(subject)\n\n    // if (t['http://www.w3.org/2000/10/swap/pim/qif#Transaction']) return \"$$\";\n    // if(kb.any(subject, UI.ns.qu('amount'))) return \"$$$\"; // In case schema not picked up\n\n    if (UI.ns.qu('Transaction') in kb.findSuperClassesNT(subject)) {\n      return 'by Trip'\n    }\n    if (t['http://www.w3.org/ns/pim/trip#Trip']) return 'Trip $'\n\n    return null // No under other circumstances (while testing at least!)\n  },\n\n  render: function (subject, context) {\n    const myDocument = context.dom\n    const kb = context.store\n    const ns = UI.ns\n    const CAL = $rdf.Namespace('http://www.w3.org/2002/12/cal/ical#')\n    const TRIP = $rdf.Namespace('http://www.w3.org/ns/pim/trip#')\n\n    const div = myDocument.createElement('div')\n    div.setAttribute('class', 'transactionPane')\n    div.innerHTML = '<h2>Trip transactions</h2>'\n\n    const complain = function complain (message, style) {\n      if (style === undefined) style = 'color: grey'\n      const pre = myDocument.createElement('pre')\n      pre.setAttribute('style', style)\n      div.appendChild(pre)\n      pre.appendChild(myDocument.createTextNode(message))\n    }\n\n    // //////////////////////////////////////////////////////////////////////////////\n    //\n    //   Body of trip pane\n\n    const t = kb.findTypeURIs(subject)\n\n    // var me = authn.currentUser()\n\n    //      Function: Render a single trip\n\n    const renderTrip = function renderTrip (subject, thisDiv) {\n      const query = new $rdf.Query(UI.utils.label(subject))\n      const vars = ['date', 'transaction', 'comment', 'type', 'in_USD']\n      const v = {}\n      vars.forEach(function (x) {\n        query.vars.push((v[x] = $rdf.variable(x)))\n      }) // Only used by UI\n      query.pat.add(v.transaction, TRIP('trip'), subject)\n\n      const opt = kb.formula()\n      opt.add(v.transaction, ns.rdf('type'), v.type) // Issue: this will get stored supertypes too\n      query.pat.optional.push(opt)\n\n      query.pat.add(v.transaction, UI.ns.qu('date'), v.date)\n\n      opt.add(v.transaction, ns.rdfs('comment'), v.comment)\n      query.pat.optional.push(opt)\n\n      // opt = kb.formula();\n      query.pat.add(v.transaction, UI.ns.qu('in_USD'), v.in_USD)\n      // query.pat.optional.push(opt);\n\n      const calculations = function () {\n        const total = {}\n        const trans = kb.each(undefined, TRIP('trip'), subject)\n        // complain(\"@@ Number of transactions in this trip: \" + trans.length);\n        trans.forEach(function (t) {\n          let ty = kb.the(t, ns.rdf('type'))\n          // complain(\" -- one trans: \"+t.uri + ' -> '+kb.any(t, UI.ns.qu('in_USD')));\n          if (!ty) ty = UI.ns.qu('ErrorNoType')\n          if (ty && ty.uri) {\n            const tyuri = ty.uri\n            if (!total[tyuri]) total[tyuri] = 0.0\n            const lit = kb.any(t, UI.ns.qu('in_USD'))\n            if (!lit) {\n              complain('    @@ No amount in USD: ' + lit + ' for ' + t)\n            }\n            if (lit) {\n              total[tyuri] = total[tyuri] + parseFloat(lit.value)\n              // complain('      Trans type ='+ty+'; in_USD \"' + lit\n              //       +'; total[tyuri] = '+total[tyuri]+';')\n            }\n          }\n        })\n        let str = ''\n        let types = 0\n        let grandTotal = 0.0\n        for (const uri in total) {\n          str += UI.utils.label(kb.sym(uri)) + ': ' + total[uri] + '; '\n          types++\n          grandTotal += total[uri]\n        }\n        complain('Totals of ' + trans.length + ' transactions: ' + str, '') // @@@@@  yucky -- need 2 col table\n        if (types > 1) {\n          complain('Overall net: ' + grandTotal, 'text-treatment: bold;')\n        }\n      }\n      const tableDiv = UI.table(myDocument, {\n        query,\n        onDone: calculations\n      })\n      thisDiv.appendChild(tableDiv)\n    }\n\n    //          Render the set of trips which have transactions in this class\n\n    if (UI.ns.qu('Transaction') in kb.findSuperClassesNT(subject)) {\n      const ts = kb.each(undefined, ns.rdf('type'), subject)\n      const triples = []\n      const index = []\n      for (let i = 0; i < ts.length; i++) {\n        const trans = ts[i]\n        const trip = kb.any(trans, TRIP('trip'))\n        if (!trip) {\n          triples.push(trans)\n        } else {\n          if (!(trans in index)) index[trip] = { total: 0, transactions: [] }\n          const usd = kb.any(trans, UI.ns.qu('in_USD'))\n          if (usd) index[trip].total += usd\n          const date = kb.any(trans, UI.ns.qu('date'))\n          index[trip.toNT()].transactions.push([date, trans])\n        }\n      }\n      /*            var byDate = function(a,b) {\n                      return new Date(kb.any(a, CAL('dtstart'))) -\n                              new Date(kb.any(b, CAL('dtstart')));\n                  }\n      */\n      const list = []\n      for (const h1 in index) {\n        const t1 = kb.fromNT(h1)\n        list.push([kb.any(t1, CAL('dtstart')), t1])\n      }\n      list.sort()\n      for (let j = 0; j < list.length; j++) {\n        const t2 = list[j][1]\n        renderTrip(t2, div)\n      }\n\n      //       Render a single trip\n    } else if (t['http://www.w3.org/ns/pim/trip#Trip']) {\n      renderTrip(subject, div)\n    }\n\n    // if (!me) complain(\"You do not have your Web Id set. Set your Web ID to make changes.\");\n\n    return div\n  }\n}\n// ends\n"],"mappings":"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","ignoreList":[]}