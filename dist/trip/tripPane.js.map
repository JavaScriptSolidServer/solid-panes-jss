{"version":3,"file":"tripPane.js","names":["UI","$rdf","ns","icon","icons","iconBase","name","audience","solid","label","subject","context","kb","session","store","t","findTypeURIs","qu","findSuperClassesNT","render","myDocument","dom","CAL","Namespace","TRIP","div","createElement","setAttribute","innerHTML","complain","message","style","undefined","pre","appendChild","createTextNode","renderTrip","thisDiv","query","Query","utils","vars","v","forEach","x","push","variable","pat","add","transaction","opt","formula","rdf","type","optional","date","rdfs","comment","in_USD","calculations","total","trans","each","ty","the","uri","tyuri","lit","any","parseFloat","value","str","types","grandTotal","sym","length","tableDiv","table","onDone","ts","triples","index","i","trip","transactions","usd","toNT","list","h1","t1","fromNT","sort","j","t2"],"sources":["../../src/trip/tripPane.js"],"sourcesContent":["/*   Trip Pane\n **\n ** This pane deals with trips themselves and also\n ** will look at transactions organized by trip.\n **\n **  This outline pane allows a user to interact with a transaction\n **  downloaded from a bank statement, annotting it with classes and comments,\n **  trips, etc\n */\n\nimport * as UI from 'solid-ui-jss'\nimport * as $rdf from 'rdflib'\nconst ns = UI.ns\n\nexport default {\n  icon: UI.icons.iconBase + 'noun_62007.svg',\n\n  name: 'travel expenses',\n\n  audience: [ns.solid('PowerUser')],\n\n  // Does the subject deserve this pane?\n  label: function (subject, context) {\n    const kb = context.session.store\n    const t = kb.findTypeURIs(subject)\n\n    // if (t['http://www.w3.org/2000/10/swap/pim/qif#Transaction']) return \"$$\";\n    // if(kb.any(subject, UI.ns.qu('amount'))) return \"$$$\"; // In case schema not picked up\n\n    if (UI.ns.qu('Transaction') in kb.findSuperClassesNT(subject)) {\n      return 'by Trip'\n    }\n    if (t['http://www.w3.org/ns/pim/trip#Trip']) return 'Trip $'\n\n    return null // No under other circumstances (while testing at least!)\n  },\n\n  render: function (subject, context) {\n    const myDocument = context.dom\n    const kb = context.store\n    const ns = UI.ns\n    const CAL = $rdf.Namespace('http://www.w3.org/2002/12/cal/ical#')\n    const TRIP = $rdf.Namespace('http://www.w3.org/ns/pim/trip#')\n\n    const div = myDocument.createElement('div')\n    div.setAttribute('class', 'transactionPane')\n    div.innerHTML = '<h2>Trip transactions</h2>'\n\n    const complain = function complain (message, style) {\n      if (style === undefined) style = 'color: grey'\n      const pre = myDocument.createElement('pre')\n      pre.setAttribute('style', style)\n      div.appendChild(pre)\n      pre.appendChild(myDocument.createTextNode(message))\n    }\n\n    // //////////////////////////////////////////////////////////////////////////////\n    //\n    //   Body of trip pane\n\n    const t = kb.findTypeURIs(subject)\n\n    // var me = authn.currentUser()\n\n    //      Function: Render a single trip\n\n    const renderTrip = function renderTrip (subject, thisDiv) {\n      const query = new $rdf.Query(UI.utils.label(subject))\n      const vars = ['date', 'transaction', 'comment', 'type', 'in_USD']\n      const v = {}\n      vars.forEach(function (x) {\n        query.vars.push((v[x] = $rdf.variable(x)))\n      }) // Only used by UI\n      query.pat.add(v.transaction, TRIP('trip'), subject)\n\n      const opt = kb.formula()\n      opt.add(v.transaction, ns.rdf('type'), v.type) // Issue: this will get stored supertypes too\n      query.pat.optional.push(opt)\n\n      query.pat.add(v.transaction, UI.ns.qu('date'), v.date)\n\n      opt.add(v.transaction, ns.rdfs('comment'), v.comment)\n      query.pat.optional.push(opt)\n\n      // opt = kb.formula();\n      query.pat.add(v.transaction, UI.ns.qu('in_USD'), v.in_USD)\n      // query.pat.optional.push(opt);\n\n      const calculations = function () {\n        const total = {}\n        const trans = kb.each(undefined, TRIP('trip'), subject)\n        // complain(\"@@ Number of transactions in this trip: \" + trans.length);\n        trans.forEach(function (t) {\n          let ty = kb.the(t, ns.rdf('type'))\n          // complain(\" -- one trans: \"+t.uri + ' -> '+kb.any(t, UI.ns.qu('in_USD')));\n          if (!ty) ty = UI.ns.qu('ErrorNoType')\n          if (ty && ty.uri) {\n            const tyuri = ty.uri\n            if (!total[tyuri]) total[tyuri] = 0.0\n            const lit = kb.any(t, UI.ns.qu('in_USD'))\n            if (!lit) {\n              complain('    @@ No amount in USD: ' + lit + ' for ' + t)\n            }\n            if (lit) {\n              total[tyuri] = total[tyuri] + parseFloat(lit.value)\n              // complain('      Trans type ='+ty+'; in_USD \"' + lit\n              //       +'; total[tyuri] = '+total[tyuri]+';')\n            }\n          }\n        })\n        let str = ''\n        let types = 0\n        let grandTotal = 0.0\n        for (const uri in total) {\n          str += UI.utils.label(kb.sym(uri)) + ': ' + total[uri] + '; '\n          types++\n          grandTotal += total[uri]\n        }\n        complain('Totals of ' + trans.length + ' transactions: ' + str, '') // @@@@@  yucky -- need 2 col table\n        if (types > 1) {\n          complain('Overall net: ' + grandTotal, 'text-treatment: bold;')\n        }\n      }\n      const tableDiv = UI.table(myDocument, {\n        query,\n        onDone: calculations\n      })\n      thisDiv.appendChild(tableDiv)\n    }\n\n    //          Render the set of trips which have transactions in this class\n\n    if (UI.ns.qu('Transaction') in kb.findSuperClassesNT(subject)) {\n      const ts = kb.each(undefined, ns.rdf('type'), subject)\n      const triples = []\n      const index = []\n      for (let i = 0; i < ts.length; i++) {\n        const trans = ts[i]\n        const trip = kb.any(trans, TRIP('trip'))\n        if (!trip) {\n          triples.push(trans)\n        } else {\n          if (!(trans in index)) index[trip] = { total: 0, transactions: [] }\n          const usd = kb.any(trans, UI.ns.qu('in_USD'))\n          if (usd) index[trip].total += usd\n          const date = kb.any(trans, UI.ns.qu('date'))\n          index[trip.toNT()].transactions.push([date, trans])\n        }\n      }\n      /*            var byDate = function(a,b) {\n                      return new Date(kb.any(a, CAL('dtstart'))) -\n                              new Date(kb.any(b, CAL('dtstart')));\n                  }\n      */\n      const list = []\n      for (const h1 in index) {\n        const t1 = kb.fromNT(h1)\n        list.push([kb.any(t1, CAL('dtstart')), t1])\n      }\n      list.sort()\n      for (let j = 0; j < list.length; j++) {\n        const t2 = list[j][1]\n        renderTrip(t2, div)\n      }\n\n      //       Render a single trip\n    } else if (t['http://www.w3.org/ns/pim/trip#Trip']) {\n      renderTrip(subject, div)\n    }\n\n    // if (!me) complain(\"You do not have your Web Id set. Set your Web ID to make changes.\");\n\n    return div\n  }\n}\n// ends\n"],"mappings":"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","ignoreList":[]}