{"version":3,"file":"dokieliPane.js","names":["UI","_interopRequireWildcard","require","$rdf","mime","_new","_interopRequireDefault","e","__esModule","default","t","WeakMap","r","n","o","i","f","__proto__","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","_default","exports","icon","icons","iconBase","name","mintClass","ns","solid","label","subject","context","kb","session","store","allowed","hasContentTypeIn","x","displayables","cts","fetcher","getHeader","j","length","k","indexOf","hasContentTypeIn2","findTypeURIs","Util","mediaTypeClass","uri","link","mintNew","newPaneOptions","newInstance","newBase","endsWith","slice","sym","contentType","lookup","includes","htmlContents","DOKIELI_TEMPLATE","filename","split","decodeURIComponent","encodedTitle","replace","Promise","resolve","webOperation","data","then","console","log","catch","err","render","myDocument","dom","div","createElement","setAttribute","iframe","setIframeAttributes","blob","lines","objectURL","URL","createObjectURL","type","_fetch","response","blobTextPromise","startsWith","text","blobText","newLines","Math","min","doc","ct","trim","tr","appendChild"],"sources":["../../src/dokieli/dokieliPane.js"],"sourcesContent":["/*   Human-readable editable \"Dokieli\" Pane\n **\n **  This outline pane contains the document contents for a Dokieli document\n ** The dokeili system allows the user to edit a document including anotations\n ** review.   It does not use turtle, but RDF/a\n */\n\nimport * as UI from 'solid-ui-jss'\nimport * as $rdf from 'rdflib'\nimport * as mime from '../utils/mimeTypes'\n\n// const DOKIELI_TEMPLATE_URI = 'https://dokie.li/new' // Copy to make new dok\n\nimport DOKIELI_TEMPLATE from './new.js' // Distributed with this library\n\nexport default {\n  icon: UI.icons.iconBase + 'dokieli-logo.png', // @@ improve? more like doccument?\n\n  name: 'Dokieli',\n\n  mintClass: UI.ns.solid('DokieliDocument'), // @@ A better class?\n\n  label: function (subject, context) {\n    const kb = context.session.store\n    const ns = UI.ns\n    const allowed = [\n      // 'text/plain',\n      'text/html',\n      'application/xhtml+xml'\n      // 'image/png', 'image/jpeg', 'application/pdf',\n      // 'video/mp4'\n    ]\n\n    const hasContentTypeIn = function (kb, x, displayables) {\n      const cts = kb.fetcher.getHeader(x, 'content-type')\n      if (cts) {\n        for (let j = 0; j < cts.length; j++) {\n          for (let k = 0; k < displayables.length; k++) {\n            if (cts[j].indexOf(displayables[k]) >= 0) {\n              return true\n            }\n          }\n        }\n      }\n      return false\n    }\n\n    // This data coul d come from a fetch OR from ldp comtaimner\n    const hasContentTypeIn2 = function (kb, x, displayables) {\n      const t = kb.findTypeURIs(x)\n      for (let k = 0; k < displayables.length; k++) {\n        if ($rdf.Util.mediaTypeClass(displayables[k]).uri in t) {\n          return true\n        }\n      }\n      return false\n    }\n\n    if (!subject.uri) return null // no bnodes\n\n    const t = kb.findTypeURIs(subject)\n    if (t[ns.link('WebPage').uri]) return 'view'\n\n    if (\n      hasContentTypeIn(kb, subject, allowed) ||\n      hasContentTypeIn2(kb, subject, allowed)\n    ) {\n      return 'Dok'\n    }\n\n    return null\n  },\n\n  // Create a new folder in a Solid system, with a dokieli editable document in it\n  mintNew: function (context, newPaneOptions) {\n    const kb = context.session.store\n    let newInstance = newPaneOptions.newInstance\n    if (!newInstance) {\n      let uri = newPaneOptions.newBase\n      if (uri.endsWith('/')) {\n        uri = uri.slice(0, -1)\n        newPaneOptions.newBase = uri\n      }\n      newInstance = kb.sym(uri)\n    }\n\n    const contentType = mime.lookup(newInstance.uri)\n    if (!contentType || !contentType.includes('html')) {\n      newInstance = $rdf.sym(newInstance.uri + '.html')\n    }\n    newPaneOptions.newInstance = newInstance // Save for creation system\n\n    // console.log('New dokieli will make: ' + newInstance)\n\n    let htmlContents = DOKIELI_TEMPLATE\n    let filename = newInstance.uri.split('/').slice(-1)[0]\n    filename = decodeURIComponent(filename.split('.')[0])\n    const encodedTitle = filename\n      .replace(/&/g, '&amp;')\n      .replace(/</g, '&lt;')\n      .replace(/>/g, '&gt;')\n    htmlContents = htmlContents.replace('<title>', '<title>' + encodedTitle)\n    htmlContents = htmlContents.replace(\n      '</article>',\n      '<h1>' + encodedTitle + '</h1></article>'\n    )\n    // console.log('@@ New HTML for Dok:' + htmlContents)\n    return new Promise(function (resolve) {\n      kb.fetcher\n        .webOperation('PUT', newInstance.uri, {\n          data: htmlContents,\n          contentType: 'text/html'\n        })\n        .then(function () {\n          console.log(\n            'new Dokieli document created at ' + newPaneOptions.newInstance\n          )\n          resolve(newPaneOptions)\n        })\n        .catch(function (err) {\n          console.log(\n            'Error creating dokieli doc at ' +\n              newPaneOptions.newInstance +\n              ': ' +\n              err\n          )\n        })\n    })\n  },\n\n  // Derived from: humanReadablePane .. share code?\n  render: function (subject, context) {\n    const myDocument = context.dom\n    const div = myDocument.createElement('div')\n    const kb = context.session.store\n\n    //  @@ When we can, use CSP to turn off scripts within the iframe\n    div.setAttribute('class', 'docView')\n    const iframe = myDocument.createElement('IFRAME')\n\n    // Function to set iframe attributes\n    const setIframeAttributes = (iframe, blob, lines) => {\n      const objectURL = URL.createObjectURL(blob)\n      iframe.setAttribute('src', objectURL)\n      iframe.setAttribute('type', blob.type)\n      iframe.setAttribute('class', 'doc')\n      iframe.setAttribute('style', `border: 1px solid; padding: 1em; height:${lines}em; width:800px; resize: both; overflow: auto;`)\n\n      // Apply sandbox attribute only for HTML files\n      // @@ NOte beflow - if we set ANY sandbox, then Chrome and Safari won't display it if it is PDF.\n      // https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe\n      // You can;'t have any sandbox and allow plugins.\n      // We could sandbox only HTML files I suppose.\n      // HTML5 bug: https://lists.w3.org/Archives/Public/public-html/2011Jun/0330.html\n      if (blob.type === 'text/html' || blob.type === 'application/xhtml+xml') {\n        iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin')\n      }\n    }\n\n    // Fetch and process the blob\n    kb.fetcher._fetch(subject.uri)\n      .then(response => response.blob())\n      .then(blob => {\n        const blobTextPromise = blob.type.startsWith('text') ? blob.text() : Promise.resolve('')\n        return blobTextPromise.then(blobText => ({ blob, blobText }))\n      })\n      .then(({ blob, blobText }) => {\n        const newLines = blobText.includes('<script src=\"https://dokie.li/scripts/dokieli.js\">') ? -10 : 5\n        const lines = Math.min(30, blobText.split(/\\n/).length + newLines)\n        setIframeAttributes(iframe, blob, lines)\n      })\n      .catch(err => {\n        console.log('Error fetching or processing blob:', err)\n      })\n\n    const cts = kb.fetcher.getHeader(subject.doc(), 'content-type')\n    const ct = cts ? cts[0].split(';', 1)[0].trim() : null\n    if (ct) {\n      console.log('dokieliPane: c-t:' + ct)\n    } else {\n      console.log('dokieliPane: unknown content-type?')\n    }\n\n    const tr = myDocument.createElement('tr')\n    tr.appendChild(iframe)\n    div.appendChild(tr)\n    return div\n  }\n}\n// ends\n"],"mappings":"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","ignoreList":[]}